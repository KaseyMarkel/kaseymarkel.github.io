<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Operational & Agronomic Metrics Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            padding: 24px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.75rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            color: #6b7280;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .last-updated {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 20px;
            align-items: center;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-right: 4px;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-chip.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .filter-divider {
            width: 1px;
            height: 24px;
            background: #d1d5db;
            margin: 0 12px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .active-filters {
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 16px;
            display: none;
        }

        .active-filters.show {
            display: block;
        }

        /* Funnel styles */
        .funnel-item {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .funnel-item:hover {
            transform: translateX(4px);
        }

        .funnel-label {
            width: 180px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .funnel-bar-container {
            flex: 1;
            height: 40px;
            background: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .funnel-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            transition: width 0.5s ease;
            min-width: 100px;
        }

        .funnel-value {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .funnel-efficiency {
            color: white;
            font-size: 0.8rem;
        }

        .funnel-target {
            width: 140px;
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Metric cards grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .metric-card {
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .metric-card.green { background: #d1fae5; }
        .metric-card.yellow { background: #fef3c7; }
        .metric-card.red { background: #fee2e2; }
        .metric-card.neutral { background: #f3f4f6; }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .metric-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .metric-icon { font-size: 1.1rem; }
        .metric-icon.green { color: #10b981; }
        .metric-icon.yellow { color: #f59e0b; }
        .metric-icon.red { color: #ef4444; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .metric-threshold {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: #1f2937;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tooltip-content {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Table styles */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
            cursor: pointer;
        }

        th:hover {
            background: #f3f4f6;
        }

        td { color: #4b5563; }
        tr:hover { background: #f9fafb; }
        tr { cursor: pointer; transition: background 0.2s; }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.green { background: #d1fae5; color: #059669; }
        .status-badge.yellow { background: #fef3c7; color: #d97706; }
        .status-badge.red { background: #fee2e2; color: #dc2626; }

        .ratio.green { color: #10b981; font-weight: 600; }
        .ratio.yellow { color: #f59e0b; font-weight: 600; }
        .ratio.red { color: #ef4444; font-weight: 600; }

        /* Speed metrics */
        .speed-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .speed-grid { grid-template-columns: 1fr; }
            .funnel-label { width: 120px; font-size: 0.8rem; }
            .funnel-target { width: 100px; }
        }

        .speed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }

        .speed-stage { font-weight: 600; color: #1f2937; }
        .speed-target { font-size: 0.8rem; color: #6b7280; margin-top: 4px; }
        .speed-days { font-size: 1.5rem; font-weight: 700; }
        .speed-days.green { color: #10b981; }
        .speed-days.yellow { color: #f59e0b; }
        .speed-days.red { color: #ef4444; }
        .speed-status { font-size: 0.8rem; color: #6b7280; }

        /* Chart */
        .chart-container {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chart-title { font-weight: 600; color: #374151; margin-bottom: 16px; }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            flex: 1;
            padding-top: 20px;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chart-bar-group:hover {
            transform: scale(1.05);
        }

        .chart-bar { width: 60px; display: flex; flex-direction: column; }
        .chart-segment { width: 100%; transition: height 0.3s; }
        .chart-segment.sampling { background: #667eea; }
        .chart-segment.genotyping { background: #764ba2; }
        .chart-segment.planning { background: #f59e0b; }
        .chart-label { font-size: 0.8rem; color: #6b7280; margin-top: 8px; }

        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        /* Issues */
        .issue-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .issue-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }

        .issue-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .issue-content { flex: 1; }
        .issue-name { font-weight: 600; color: #1f2937; }
        .issue-details { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
        .issue-meta { text-align: right; }

        .issue-impact {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .issue-impact.high { background: #fee2e2; color: #dc2626; }
        .issue-impact.medium { background: #fef3c7; color: #d97706; }
        .issue-impact.low { background: #d1fae5; color: #059669; }
        .issue-trend { font-size: 0.8rem; color: #6b7280; margin-top: 4px; }

        /* Stack */
        .stack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .stack-card {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stack-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .stack-level { font-size: 0.9rem; font-weight: 500; color: #6b7280; margin-bottom: 8px; }
        .stack-count { font-size: 2.5rem; font-weight: 700; color: #764ba2; margin-bottom: 8px; }
        .stack-target { font-size: 0.8rem; color: #6b7280; }
        .stack-status { margin-top: 12px; font-size: 0.9rem; font-weight: 600; }
        .stack-status.achieved { color: #10b981; }
        .stack-status.pending { color: #f59e0b; }

        /* Progress bar for stack */
        .stack-progress {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }

        .stack-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Summary grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .summary-item.clickable {
            cursor: pointer;
        }

        .summary-item.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #764ba2;
        }

        .summary-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Two column layout for side by side sections */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .two-column { grid-template-columns: 1fr; }
        }

        /* Modal for drill-down */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #e5e7eb;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 16px;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .footer p { margin: 4px 0; }

        .loading { display: inline-block; animation: spin 1s linear infinite; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Transition for filter changes */
        .fade-update {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Header -->
        <div class="glass-card">
            <div class="header">
                <div>
                    <h1>üå± BC Operational & Agronomic Metrics</h1>
                    <p>Interactive breeding program performance dashboard</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <span id="refresh-icon">‚Üª</span> Refresh
                    </button>
                    <span class="last-updated">Last updated: <span id="last-updated-time">-</span></span>
                </div>
            </div>
            <div class="filters" id="filters-container">
                <span class="filter-label">Region:</span>
                <div id="region-filters"></div>
                <div class="filter-divider"></div>
                <span class="filter-label">Trait:</span>
                <div id="trait-filters"></div>
            </div>
        </div>

        <!-- Active filter indicator -->
        <div class="active-filters" id="active-filters"></div>

        <!-- Block A: Funnel -->
        <div class="glass-card">
            <h2 class="section-title">üìä Block A: Pipeline Funnel</h2>
            <div id="funnel-container"></div>
        </div>

        <!-- Block B: Rates -->
        <div class="glass-card">
            <h2 class="section-title">üìà Block B: Efficiency Rates</h2>
            <div class="metrics-grid" id="rates-container"></div>
        </div>

        <!-- Block C: Coverage -->
        <div class="glass-card">
            <h2 class="section-title">üìã Block C: Coverage Analysis</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('scheme')">Scheme/Stage ‚Üï</th>
                            <th style="text-align: right;" onclick="sortTable('required')">Required ‚Üï</th>
                            <th style="text-align: right;" onclick="sortTable('available')">Available ‚Üï</th>
                            <th style="text-align: right;" onclick="sortTable('ratio')">Coverage ‚Üï</th>
                            <th style="text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="coverage-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Block D: Speed (Flowering metrics only - cycle time data not available) -->
        <div class="glass-card">
            <h2 class="section-title">‚ö° Block D: Flowering & Timing</h2>
            <div id="speed-metrics"></div>
        </div>

        <!-- Top Issues -->
        <div class="glass-card">
            <h2 class="section-title">‚ö†Ô∏è Top Operational Issues</h2>
            <div id="issues-container"></div>
        </div>

        <!-- Block E: Biofortification Metrics -->
        <div class="glass-card">
            <h2 class="section-title">üåæ Block E: Biofortification Quality</h2>
            <div class="metrics-grid" id="biofort-container"></div>
        </div>

        <!-- Block F: Stack Progress -->
        <div class="glass-card">
            <h2 class="section-title">üß¨ Block F: Trait Pyramiding Progress</h2>
            <div class="stack-grid" id="stack-container"></div>
        </div>

        <!-- Block G: Plant Characteristics -->
        <div class="glass-card">
            <h2 class="section-title">üåø Block G: Plant Characteristics</h2>
            <div class="metrics-grid" id="plant-container"></div>
        </div>

        <!-- Summary Stats Row -->
        <div class="glass-card">
            <h2 class="section-title">üìà Summary Statistics</h2>
            <div class="summary-grid" id="summary-container"></div>
        </div>

        <!-- Footer -->
        <div class="glass-card footer">
            <p>üìä Data from BMS export ¬∑ Click any element for details</p>
            <p>üîÑ Refresh data by re-running the BMS export script</p>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title" id="tooltip-title"></div>
        <div class="tooltip-content" id="tooltip-content"></div>
    </div>

    <!-- Modal for drill-down -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // State
        var filters = { region: 'All', trait: 'All' };
        var cachedData = null;
        var currentData = null;
        var sortState = { column: null, direction: 1 };

        // Load data from JSON file
        function loadDashboardData(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'dashboard_data.json?t=' + Date.now(), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            cachedData = JSON.parse(xhr.responseText);
                            callback(cachedData);
                        } catch (e) {
                            console.log('Error parsing JSON:', e);
                            callback(generateFallbackData());
                        }
                    } else {
                        console.log('Could not load dashboard_data.json');
                        callback(generateFallbackData());
                    }
                }
            };
            xhr.send();
        }

        // Fallback data
        function generateFallbackData() {
            return {
                filters: { regions: ['All'], traits: ['All'] },
                funnelData: [
                    { name: 'Total Studies', value: 402, target: 400, efficiency: 100 }
                ],
                rateMetrics: [
                    { name: 'Virus Rate', value: 4.2, threshold: 5, status: 'green' }
                ],
                coverageMetrics: [],
                speedMetrics: [],
                topIssues: [],
                stackProgress: [],
                cycleTimeHistory: [],
                byRegion: {},
                byTrait: {},
                studies: []
            };
        }

        // Get filtered data
        function getFilteredData(data) {
            // Start with all data
            var result = {
                funnelData: data.funnelData,
                rateMetrics: data.rateMetrics,
                coverageMetrics: data.coverageMetrics,
                speedMetrics: data.speedMetrics,
                topIssues: data.topIssues,
                stackProgress: data.stackProgress,
                cycleTimeHistory: data.cycleTimeHistory,
                biofortMetrics: data.biofortMetrics,
                plantMetrics: data.plantMetrics,
                summary: data.summary
            };

            // Apply region filter
            if (filters.region !== 'All' && data.byRegion && data.byRegion[filters.region]) {
                var regionData = data.byRegion[filters.region];
                result.funnelData = regionData.funnelData || result.funnelData;
                result.rateMetrics = regionData.rateMetrics || result.rateMetrics;
                result.coverageMetrics = regionData.coverageMetrics || result.coverageMetrics;
                result.topIssues = regionData.topIssues || result.topIssues;
                result.stackProgress = regionData.stackProgress || result.stackProgress;
                result.biofortMetrics = regionData.biofortMetrics || result.biofortMetrics;
                result.plantMetrics = regionData.plantMetrics || result.plantMetrics;
                result.summary = regionData.summary || result.summary;
            }

            // Apply trait filter
            if (filters.trait !== 'All' && data.byTrait && data.byTrait[filters.trait]) {
                var traitData = data.byTrait[filters.trait];
                result.funnelData = traitData.funnelData || result.funnelData;
                result.rateMetrics = traitData.rateMetrics || result.rateMetrics;
                result.coverageMetrics = traitData.coverageMetrics || result.coverageMetrics;
                result.topIssues = traitData.topIssues || result.topIssues;
                result.stackProgress = traitData.stackProgress || result.stackProgress;
                result.biofortMetrics = traitData.biofortMetrics || result.biofortMetrics;
                result.plantMetrics = traitData.plantMetrics || result.plantMetrics;
                result.summary = traitData.summary || result.summary;
            }

            return result;
        }

        // Render filter chips
        function renderFilters(data) {
            var regionContainer = document.getElementById('region-filters');
            var traitContainer = document.getElementById('trait-filters');

            var regions = data.filters ? data.filters.regions : ['All'];
            var traits = data.filters ? data.filters.traits : ['All'];

            var regionHtml = '';
            for (var i = 0; i < regions.length; i++) {
                var active = filters.region === regions[i] ? 'active' : '';
                regionHtml += '<button class="filter-chip ' + active + '" data-group="region" data-value="' + regions[i] + '">' + regions[i] + '</button> ';
            }
            regionContainer.innerHTML = regionHtml;

            var traitHtml = '';
            for (var i = 0; i < traits.length; i++) {
                var active = filters.trait === traits[i] ? 'active' : '';
                traitHtml += '<button class="filter-chip ' + active + '" data-group="trait" data-value="' + traits[i] + '">' + traits[i] + '</button> ';
            }
            traitContainer.innerHTML = traitHtml;

            // Update active filters display
            var activeFiltersEl = document.getElementById('active-filters');
            if (filters.region !== 'All' || filters.trait !== 'All') {
                var filterText = 'Showing: ';
                if (filters.region !== 'All') filterText += 'Region: ' + filters.region;
                if (filters.region !== 'All' && filters.trait !== 'All') filterText += ' | ';
                if (filters.trait !== 'All') filterText += 'Trait: ' + filters.trait;
                activeFiltersEl.textContent = filterText;
                activeFiltersEl.classList.add('show');
            } else {
                activeFiltersEl.classList.remove('show');
            }
        }

        // Render funnel
        function renderFunnel(data) {
            var container = document.getElementById('funnel-container');
            var maxValue = data[0] ? data[0].value : 1;
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var width = Math.max(20, (item.value / maxValue) * 100);
                html += '<div class="funnel-item" onclick="showFunnelDetails(\'' + item.name + '\')" onmouseenter="showTooltip(event, \'' + item.name + '\', \'Click to see detailed breakdown\')" onmouseleave="hideTooltip()">' +
                    '<div class="funnel-label">' + item.name + '</div>' +
                    '<div class="funnel-bar-container">' +
                        '<div class="funnel-bar" style="width: ' + width + '%;">' +
                            '<span class="funnel-value">' + item.value.toLocaleString() + '</span>' +
                            '<span class="funnel-efficiency">' + item.efficiency + '%</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="funnel-target">Target: ' + item.target.toLocaleString() + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
            container.classList.add('fade-update');
            setTimeout(function() { container.classList.remove('fade-update'); }, 300);
        }

        // Render rate metrics
        function renderRates(data) {
            var container = document.getElementById('rates-container');
            var icons = { green: '‚úì', yellow: '‚ö†', red: '‚úó', neutral: '‚óã' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var m = data[i];
                var displayValue = m.name.includes('%') ? m.value.toFixed(3) : m.value.toFixed(1);
                var unit = m.unit || (m.name.includes('ppm') ? 'ppm' : (m.name.includes('t/ha') ? 't/ha' : '%'));
                var statusClass = m.status || 'neutral';
                var hasThreshold = m.threshold !== null && m.threshold !== undefined;
                var tooltipText = hasThreshold ? 'Threshold: ' + m.threshold + ' ' + unit + ' | Status: ' + statusClass : unit;
                var thresholdText = hasThreshold ? 'Threshold: ' + m.threshold : unit;

                html += '<div class="metric-card ' + statusClass + '" onclick="showMetricDetails(\'' + m.name + '\')" onmouseenter="showTooltip(event, \'' + m.name + '\', \'' + tooltipText + '\')" onmouseleave="hideTooltip()">' +
                    '<div class="metric-header">' +
                        '<span class="metric-name">' + m.name + '</span>' +
                        (statusClass !== 'neutral' ? '<span class="metric-icon ' + statusClass + '">' + icons[statusClass] + '</span>' : '') +
                    '</div>' +
                    '<div class="metric-value">' + displayValue + (m.name.includes('%') || m.name.includes('Rate') ? '%' : '') + '</div>' +
                    '<div class="metric-threshold">' + thresholdText + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
            container.classList.add('fade-update');
            setTimeout(function() { container.classList.remove('fade-update'); }, 300);
        }

        // Render coverage table
        function renderCoverage(data) {
            var tbody = document.getElementById('coverage-body');
            var statusLabels = { green: 'Good', yellow: 'Watch', red: 'Critical' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<tr onclick="showCoverageDetails(\'' + item.scheme + '\')">' +
                    '<td style="font-weight: 500;">' + item.scheme + '</td>' +
                    '<td style="text-align: right;">' + item.required + '</td>' +
                    '<td style="text-align: right; font-weight: 600;">' + item.available + '</td>' +
                    '<td style="text-align: right;"><span class="ratio ' + item.status + '">' + item.ratio.toFixed(2) + 'x</span></td>' +
                    '<td style="text-align: center;"><span class="status-badge ' + item.status + '">' + statusLabels[item.status] + '</span></td>' +
                '</tr>';
            }
            tbody.innerHTML = html;
        }

        // Render speed metrics
        function renderSpeed(data) {
            var container = document.getElementById('speed-metrics');
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var statusText = item.days <= item.target ? '‚úì On track' : '‚ö† Delayed';
                html += '<div class="speed-item" onclick="showSpeedDetails(\'' + item.stage + '\')" onmouseenter="showTooltip(event, \'' + item.stage + '\', \'Target: ' + item.target + ' days\')" onmouseleave="hideTooltip()">' +
                    '<div>' +
                        '<div class="speed-stage">' + item.stage + '</div>' +
                        '<div class="speed-target">Target: ' + item.target + ' days</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                        '<div class="speed-days ' + item.status + '">' + item.days + 'd</div>' +
                        '<div class="speed-status">' + statusText + '</div>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render cycle chart
        function renderCycleChart(data) {
            var container = document.getElementById('cycle-chart');
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No cycle data available</p>';
                return;
            }

            var maxTotal = 0;
            for (var i = 0; i < data.length; i++) {
                var total = data[i].sampling + data[i].genotyping + data[i].planning;
                if (total > maxTotal) maxTotal = total;
            }
            var scale = 180 / maxTotal;
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var total = item.sampling + item.genotyping + item.planning;
                html += '<div class="chart-bar-group" onclick="showCycleDetails(\'' + item.cycle + '\')" onmouseenter="showTooltip(event, \'Cycle ' + item.cycle + '\', \'Total: ' + total + ' days<br>Sampling: ' + item.sampling + 'd<br>Genotyping: ' + item.genotyping + 'd<br>Planning: ' + item.planning + 'd\')" onmouseleave="hideTooltip()">' +
                    '<div class="chart-bar">' +
                        '<div class="chart-segment planning" style="height: ' + (item.planning * scale) + 'px;"></div>' +
                        '<div class="chart-segment genotyping" style="height: ' + (item.genotyping * scale) + 'px;"></div>' +
                        '<div class="chart-segment sampling" style="height: ' + (item.sampling * scale) + 'px;"></div>' +
                    '</div>' +
                    '<div class="chart-label">' + item.cycle + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render issues
        function renderIssues(data) {
            var container = document.getElementById('issues-container');
            var trendIcons = { increasing: 'üìà', decreasing: 'üìâ', stable: '‚û°Ô∏è' };
            var html = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No issues recorded for current filter selection</p>';
                return;
            }

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<div class="issue-item" onclick="showIssueDetails(\'' + item.issue + '\')" onmouseenter="showTooltip(event, \'' + item.issue + '\', \'Affected: ' + item.plants + ' observations (' + item.pct + '%)\')" onmouseleave="hideTooltip()">' +
                    '<div class="issue-rank">' + item.rank + '</div>' +
                    '<div class="issue-content">' +
                        '<div class="issue-name">' + item.issue + '</div>' +
                        '<div class="issue-details">' + item.plants + ' observations affected ¬∑ ' + item.pct + '% above threshold</div>' +
                    '</div>' +
                    '<div class="issue-meta">' +
                        '<span class="issue-impact ' + item.impact.toLowerCase() + '">' + item.impact + ' Impact</span>' +
                        '<div class="issue-trend">Trend: ' + (trendIcons[item.trend] || '‚û°Ô∏è') + ' ' + item.trend + '</div>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render stack progress
        function renderStack(data) {
            var container = document.getElementById('stack-container');
            var html = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No biofortification data for current filter selection</p>';
                return;
            }

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var achieved = item.count >= item.target;
                var statusClass = achieved ? 'achieved' : 'pending';
                var statusText = achieved ? '‚úì Target achieved' : (item.target - item.count) + ' more needed';
                var progress = Math.min(100, Math.round((item.count / item.target) * 100));

                html += '<div class="stack-card" onclick="showStackDetails(\'' + item.level + '\')">' +
                    '<div class="stack-level">' + item.level + '</div>' +
                    '<div class="stack-count">' + item.count.toLocaleString() + '</div>' +
                    '<div class="stack-target">Target: ' + item.target.toLocaleString() + '</div>' +
                    '<div class="stack-progress"><div class="stack-progress-fill" style="width: ' + progress + '%;"></div></div>' +
                    '<div class="stack-status ' + statusClass + '">' + statusText + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render biofortification metrics
        function renderBiofort(data) {
            var container = document.getElementById('biofort-container');
            if (!container) return;
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No biofortification data available</p>';
                return;
            }

            var icons = { green: '‚úì', yellow: '‚ö†', red: '‚úó', neutral: '‚óã' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var m = data[i];
                var displayValue = m.value;
                if (m.unit === '%' && m.value < 1) {
                    displayValue = m.value.toFixed(3);
                } else if (m.unit === 'ppm') {
                    displayValue = m.value.toFixed(1);
                } else {
                    displayValue = m.value.toFixed(2);
                }

                var statusClass = m.status || 'neutral';
                var thresholdText = m.target ? 'Target: ' + m.target + ' ' + m.unit : m.unit;

                html += '<div class="metric-card ' + statusClass + '" onclick="showBiofortDetails(\'' + m.name + '\')">' +
                    '<div class="metric-header">' +
                        '<span class="metric-name">' + m.name + '</span>' +
                        (statusClass !== 'neutral' ? '<span class="metric-icon ' + statusClass + '">' + icons[statusClass] + '</span>' : '') +
                    '</div>' +
                    '<div class="metric-value">' + displayValue + '</div>' +
                    '<div class="metric-threshold">' + thresholdText + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render plant metrics
        function renderPlantMetrics(data) {
            var container = document.getElementById('plant-container');
            if (!container) return;
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No plant data available</p>';
                return;
            }

            var html = '';
            for (var i = 0; i < data.length; i++) {
                var m = data[i];
                var pct = m.target > 0 ? Math.round((m.value / m.target) * 100) : 0;
                var status = pct >= 90 ? 'green' : (pct >= 70 ? 'yellow' : 'red');

                html += '<div class="metric-card ' + status + '">' +
                    '<div class="metric-header">' +
                        '<span class="metric-name">' + m.name + '</span>' +
                    '</div>' +
                    '<div class="metric-value">' + m.value.toFixed(1) + '</div>' +
                    '<div class="metric-threshold">Target: ' + m.target + ' ' + m.unit + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render summary stats (clickable)
        function renderSummary(data) {
            var container = document.getElementById('summary-container');
            if (!container || !data) return;

            var items = [
                { label: 'Studies', value: data.totalStudies || 0, key: 'studies', type: 'timeseries' },
                { label: 'Active', value: data.activeStudies || 0, key: 'active', type: 'timeseries' },
                { label: 'Obs Units', value: data.totalObsUnits || 0, key: 'observations', type: 'timeseries' },
                { label: 'Plants', value: data.plantsHarvested || 0, key: 'plants', type: 'info' },
                { label: 'Ears', value: data.earsHarvested || 0, key: 'ears', type: 'info' },
                { label: 'Yield (t/ha)', value: data.avgYield || 0, key: 'yield', type: 'distribution' },
                { label: 'Zinc (ppm)', value: data.avgZinc || 0, key: 'zinc', type: 'distribution' },
                { label: 'Trp (%)', value: data.avgTryptophan || 0, key: 'tryptophan', type: 'distribution' },
            ];

            var html = '';
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var val = typeof item.value === 'number' ?
                    (item.value > 1000 ? item.value.toLocaleString() :
                     item.value < 1 ? item.value.toFixed(3) : item.value.toFixed(1)) : item.value;
                html += '<div class="summary-item clickable" onclick="showSummaryDetails(\'' + item.key + '\', \'' + item.type + '\', \'' + item.label + '\')">' +
                    '<div class="summary-value">' + val + '</div>' +
                    '<div class="summary-label">' + item.label + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // Render histogram chart
        function renderHistogram(dist, title, unit) {
            if (!dist || !dist.bins || dist.bins.length === 0) {
                return '<p style="color: #6b7280;">No distribution data available.</p>';
            }

            var width = 450, height = 220;
            var marginLeft = 50, marginRight = 20, marginTop = 30, marginBottom = 50;
            var chartWidth = width - marginLeft - marginRight;
            var chartHeight = height - marginTop - marginBottom;

            var maxCount = Math.max.apply(null, dist.counts);
            var barWidth = chartWidth / dist.bins.length - 2;

            var svg = '<svg width="' + width + '" height="' + height + '" style="background: #f9fafb; border-radius: 8px; font-family: Inter, sans-serif;">';

            // Y-axis grid lines and labels
            var yTicks = 5;
            for (var t = 0; t <= yTicks; t++) {
                var yPos = marginTop + chartHeight - (t / yTicks) * chartHeight;
                var tickVal = Math.round(maxCount * t / yTicks);
                svg += '<line x1="' + marginLeft + '" y1="' + yPos + '" x2="' + (width - marginRight) + '" y2="' + yPos + '" stroke="#e5e7eb" stroke-dasharray="' + (t === 0 ? '0' : '4,4') + '" />';
                svg += '<text x="' + (marginLeft - 8) + '" y="' + (yPos + 4) + '" font-size="10" fill="#6b7280" text-anchor="end">' + tickVal + '</text>';
            }

            // Y-axis title
            svg += '<text x="14" y="' + (marginTop + chartHeight / 2) + '" font-size="11" fill="#374151" text-anchor="middle" transform="rotate(-90, 14, ' + (marginTop + chartHeight / 2) + ')">Count</text>';

            // Bars
            for (var i = 0; i < dist.bins.length; i++) {
                var x = marginLeft + i * (chartWidth / dist.bins.length) + 1;
                var barHeight = (dist.counts[i] / maxCount) * chartHeight;
                var y = marginTop + chartHeight - barHeight;

                svg += '<rect x="' + x + '" y="' + y + '" width="' + barWidth + '" height="' + barHeight + '" fill="#667eea" rx="2" />';
            }

            // X-axis labels (show a few)
            var xLabelsToShow = [0, Math.floor(dist.bins.length / 2), dist.bins.length - 1];
            for (var i = 0; i < xLabelsToShow.length; i++) {
                var idx = xLabelsToShow[i];
                var x = marginLeft + idx * (chartWidth / dist.bins.length) + barWidth / 2;
                svg += '<text x="' + x + '" y="' + (height - marginBottom + 18) + '" font-size="10" fill="#6b7280" text-anchor="middle">' + dist.bins[idx].toFixed(1) + '</text>';
            }

            // X-axis title
            svg += '<text x="' + (marginLeft + chartWidth / 2) + '" y="' + (height - 8) + '" font-size="11" fill="#374151" text-anchor="middle">' + unit + '</text>';

            svg += '</svg>';

            // Stats summary
            var stats = '<div style="display: flex; gap: 20px; justify-content: center; margin-top: 16px;">';
            stats += '<div style="text-align: center;"><div style="font-weight: 600; color: #374151;">' + dist.n.toLocaleString() + '</div><div style="font-size: 0.8rem; color: #6b7280;">Samples</div></div>';
            stats += '<div style="text-align: center;"><div style="font-weight: 600; color: #374151;">' + dist.mean + '</div><div style="font-size: 0.8rem; color: #6b7280;">Mean</div></div>';
            stats += '<div style="text-align: center;"><div style="font-weight: 600; color: #374151;">' + dist.min + '</div><div style="font-size: 0.8rem; color: #6b7280;">Min</div></div>';
            stats += '<div style="text-align: center;"><div style="font-weight: 600; color: #374151;">' + dist.max + '</div><div style="font-size: 0.8rem; color: #6b7280;">Max</div></div>';
            stats += '</div>';

            return svg + stats;
        }

        // Render a pie chart as SVG
        function renderPieChart(data, title) {
            if (!data || data.length === 0) {
                return '<p style="color: #6b7280;">No data available.</p>';
            }

            var width = 300, height = 220;
            var cx = 120, cy = 100, radius = 80;

            // Calculate total
            var total = 0;
            for (var i = 0; i < data.length; i++) {
                total += data[i].count;
            }

            // Colors for pie slices
            var colors = ['#667eea', '#764ba2', '#f59e0b', '#10b981', '#ef4444', '#6366f1', '#8b5cf6', '#ec4899'];

            var svg = '<svg width="' + width + '" height="' + height + '" style="font-family: Inter, sans-serif;">';

            var startAngle = 0;
            for (var i = 0; i < data.length; i++) {
                var slice = data[i];
                var sliceAngle = (slice.count / total) * 2 * Math.PI;
                var endAngle = startAngle + sliceAngle;

                // Calculate arc path
                var x1 = cx + radius * Math.cos(startAngle);
                var y1 = cy + radius * Math.sin(startAngle);
                var x2 = cx + radius * Math.cos(endAngle);
                var y2 = cy + radius * Math.sin(endAngle);
                var largeArc = sliceAngle > Math.PI ? 1 : 0;

                var path = 'M ' + cx + ' ' + cy + ' L ' + x1 + ' ' + y1 + ' A ' + radius + ' ' + radius + ' 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z';
                svg += '<path d="' + path + '" fill="' + colors[i % colors.length] + '" stroke="white" stroke-width="2" />';

                startAngle = endAngle;
            }

            svg += '</svg>';

            // Legend
            var legend = '<div style="display: flex; flex-direction: column; gap: 6px; margin-left: 16px;">';
            for (var i = 0; i < data.length; i++) {
                var pct = Math.round((data[i].count / total) * 100);
                legend += '<div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">';
                legend += '<div style="width: 12px; height: 12px; border-radius: 2px; background: ' + colors[i % colors.length] + ';"></div>';
                legend += '<span>' + data[i].region + ': ' + data[i].count.toLocaleString() + ' (' + pct + '%)</span>';
                legend += '</div>';
            }
            legend += '</div>';

            return '<div style="display: flex; align-items: center;">' + svg + legend + '</div>';
        }

        // Show summary stat details
        function showSummaryDetails(key, type, label) {
            var html = '<div style="padding: 20px;">';

            if (type === 'distribution' && cachedData.distributions && cachedData.distributions[key]) {
                var dist = cachedData.distributions[key];
                var unit = key === 'zinc' ? 'ppm' : (key === 'tryptophan' ? '%' : 't/ha');
                html += '<h3 style="margin-bottom: 16px;">' + label + ' Distribution</h3>';
                html += renderHistogram(dist, label, unit);

                // For yield, also show yield over time with raw data
                if (key === 'yield' && cachedData.historicalTrends) {
                    var trends = cachedData.historicalTrends;
                    html += '<h3 style="margin: 24px 0 16px 0;">üìà Yield Over Time</h3>';
                    html += renderTrendChart(trends.periods, trends.yield, 'Yield', 't/ha');

                    // Raw data table
                    html += '<h4 style="margin: 20px 0 12px 0;">Raw Data by Quarter</h4>';
                    html += '<div style="max-height: 200px; overflow-y: auto;">';
                    html += '<table style="width: 100%; font-size: 0.8rem;"><thead><tr><th>Period</th><th style="text-align:right;">Avg (t/ha)</th><th style="text-align:right;">Min</th><th style="text-align:right;">Max</th><th style="text-align:right;">Samples</th></tr></thead><tbody>';
                    for (var i = trends.periods.length - 1; i >= 0; i--) {
                        var raw = trends.yieldRaw[i];
                        if (raw && raw.count > 0) {
                            html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + raw.avg.toFixed(2) + '</td><td style="text-align:right;">' + raw.min + '</td><td style="text-align:right;">' + raw.max + '</td><td style="text-align:right;">' + raw.count + '</td></tr>';
                        }
                    }
                    html += '</tbody></table></div>';

                    // Region breakdown
                    if (cachedData.regionBreakdown && cachedData.regionBreakdown.yieldByRegion) {
                        html += '<h4 style="margin: 20px 0 12px 0;">Yield by Region</h4>';
                        var yieldByRegion = cachedData.regionBreakdown.yieldByRegion;
                        html += '<table style="width: 100%; font-size: 0.85rem;"><thead><tr><th>Region</th><th style="text-align:right;">Avg Yield (t/ha)</th><th style="text-align:right;">Samples</th></tr></thead><tbody>';
                        for (var i = 0; i < yieldByRegion.length; i++) {
                            html += '<tr><td>' + yieldByRegion[i].region + '</td><td style="text-align:right;">' + yieldByRegion[i].avg + '</td><td style="text-align:right;">' + yieldByRegion[i].count + '</td></tr>';
                        }
                        html += '</tbody></table>';
                    }
                }
            } else if (type === 'timeseries' && cachedData.historicalTrends) {
                var trends = cachedData.historicalTrends;
                html += '<h3 style="margin-bottom: 16px;">' + label + ' Over Time</h3>';
                if (key === 'studies' || key === 'active') {
                    html += renderTrendChart(trends.periods, trends.studies, label, 'count');
                } else if (key === 'observations') {
                    html += renderTrendChart(trends.periods, trends.observations, label, 'count');
                }
                // Data table
                html += '<div style="margin-top: 16px; max-height: 150px; overflow-y: auto;">';
                html += '<table style="width: 100%; font-size: 0.8rem;"><thead><tr><th>Period</th><th style="text-align:right;">Count</th></tr></thead><tbody>';
                var dataKey = key === 'observations' ? 'observations' : 'studies';
                for (var i = trends.periods.length - 1; i >= 0; i--) {
                    html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + trends[dataKey][i].toLocaleString() + '</td></tr>';
                }
                html += '</tbody></table></div>';
            } else if ((key === 'plants' || key === 'ears') && cachedData.historicalTrends) {
                // Time series for plants/ears harvested
                var trends = cachedData.historicalTrends;
                var dataKey = key === 'plants' ? 'plantsHarvested' : 'earsHarvested';

                html += '<h3 style="margin-bottom: 16px;">' + label + ' Harvested Over Time</h3>';
                html += renderTrendChart(trends.periods, trends[dataKey], label, 'count');

                // Data table
                html += '<h4 style="margin: 20px 0 12px 0;">Data by Quarter</h4>';
                html += '<div style="max-height: 150px; overflow-y: auto;">';
                html += '<table style="width: 100%; font-size: 0.8rem;"><thead><tr><th>Period</th><th style="text-align:right;">Count</th></tr></thead><tbody>';
                for (var i = trends.periods.length - 1; i >= 0; i--) {
                    var val = trends[dataKey][i];
                    if (val > 0) {
                        html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + val.toLocaleString() + '</td></tr>';
                    }
                }
                html += '</tbody></table></div>';

                // Pie chart for region breakdown
                if (cachedData.regionBreakdown) {
                    var regionData = key === 'plants' ? cachedData.regionBreakdown.plantsByRegion : cachedData.regionBreakdown.earsByRegion;
                    if (regionData && regionData.length > 0) {
                        html += '<h4 style="margin: 24px 0 12px 0;">ü•ß Breakdown by Region</h4>';
                        html += renderPieChart(regionData, label + ' by Region');
                    }
                }
            } else {
                html += '<p>Detailed breakdown for ' + label + '</p>';
            }

            html += '</div>';
            showModal(label + ' - Details', html);
        }

        // Drill-down for biofort
        function showBiofortDetails(name) {
            var trends = cachedData.historicalTrends;
            if (!trends || !trends.periods) {
                showModal(name, '<p>No historical data available.</p>');
                return;
            }

            // Map metric name to trend data key
            var dataKey = 'zinc';
            var unit = 'ppm';
            if (name.includes('Tryptophan')) {
                dataKey = 'tryptophan';
                unit = '%';
            } else if (name.includes('Yield')) {
                dataKey = 'yield';
                unit = 't/ha';
            }

            var html = '<div style="padding: 20px;">';
            html += '<h3 style="margin-bottom: 16px;">' + name + ' Trend</h3>';
            html += renderTrendChart(trends.periods, trends[dataKey], name, unit);

            // Find current metric for context
            var metric = currentData.biofortMetrics ? currentData.biofortMetrics.find(function(m) { return m.name === name; }) : null;
            if (metric) {
                html += '<div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">';
                html += '<div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px;">';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: #764ba2;">' + metric.value + '</div>';
                html += '<div style="font-size: 0.8rem; color: #6b7280;">Current</div></div>';
                html += '<div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px;">';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">' + metric.target + '</div>';
                html += '<div style="font-size: 0.8rem; color: #6b7280;">Target</div></div>';
                html += '</div>';
            }

            // Data table
            html += '<div style="margin-top: 20px;">';
            html += '<table style="width: 100%; font-size: 0.85rem;"><thead><tr><th>Period</th><th style="text-align:right;">Avg ' + unit + '</th><th style="text-align:right;">Observations</th></tr></thead><tbody>';
            for (var i = 0; i < trends.periods.length; i++) {
                var val = trends[dataKey][i];
                if (val > 0) {
                    html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + val + '</td><td style="text-align:right;">' + trends.observations[i].toLocaleString() + '</td></tr>';
                }
            }
            html += '</tbody></table></div></div>';

            showModal(name + ' - Historical Trend', html);
        }

        function updateLastUpdated(timestamp) {
            if (timestamp) {
                var date = new Date(timestamp);
                document.getElementById('last-updated-time').textContent = date.toLocaleString();
            } else {
                document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString();
            }
        }

        // Tooltip functions
        function showTooltip(event, title, content) {
            var tooltip = document.getElementById('tooltip');
            document.getElementById('tooltip-title').textContent = title;
            document.getElementById('tooltip-content').innerHTML = content;

            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // Modal functions
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('show');
        }

        function closeModal(event) {
            if (!event || event.target === document.getElementById('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('show');
            }
        }

        // Drill-down functions
        function showFunnelDetails(name) {
            var studies = cachedData.studies || [];
            var filtered = studies;

            if (filters.region !== 'All') {
                filtered = filtered.filter(function(s) { return s.region === filters.region; });
            }
            if (filters.trait !== 'All') {
                filtered = filtered.filter(function(s) { return s.trait === filters.trait; });
            }

            var html = '<p style="margin-bottom: 16px;"><strong>' + filtered.length + '</strong> studies match current filters</p>';
            html += '<table style="width: 100%;"><thead><tr><th>Study Name</th><th>Location</th><th>Program</th><th style="text-align: right;">Observations</th></tr></thead><tbody>';

            var shown = filtered.slice(0, 20);
            for (var i = 0; i < shown.length; i++) {
                var s = shown[i];
                html += '<tr><td>' + s.name + '</td><td>' + s.location + '</td><td>' + s.program + '</td><td style="text-align: right;">' + s.observations + '</td></tr>';
            }
            html += '</tbody></table>';

            if (filtered.length > 20) {
                html += '<p style="margin-top: 12px; color: #6b7280;">Showing 20 of ' + filtered.length + ' studies</p>';
            }

            showModal(name + ' - Study Details', html);
        }

        function showMetricDetails(name) {
            var metric = currentData.rateMetrics.find(function(m) { return m.name === name; });
            if (!metric) return;

            var trends = cachedData.historicalTrends;

            // Map metric to trend key
            var dataKey = null;
            if (name.includes('Virus') || name.includes('Spiroplasma')) dataKey = 'virus';
            else if (name.includes('Lodging')) dataKey = 'lodging';
            else if (name.includes('Yield')) dataKey = 'yield';

            var html = '<div style="padding: 20px;">';
            html += '<div style="text-align: center;">';
            html += '<div style="font-size: 3rem; font-weight: 700; color: ' + (metric.status === 'green' ? '#10b981' : metric.status === 'yellow' ? '#f59e0b' : '#ef4444') + ';">' + metric.value + '</div>';
            html += '<div style="color: #6b7280; margin-top: 8px;">Threshold: ' + metric.threshold + '</div>';
            html += '<div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; display: inline-block;">';
            html += '<strong>Status:</strong> ' + (metric.status === 'green' ? '‚úì Within acceptable range' : metric.status === 'yellow' ? '‚ö† Needs attention' : '‚úó Critical') + '</div>';
            html += '</div>';

            // Show trend chart if data available
            if (trends && trends.periods && dataKey) {
                html += '<div style="margin-top: 24px;">';
                html += '<h4 style="margin-bottom: 12px;">Historical Trend</h4>';
                html += renderTrendChart(trends.periods, trends[dataKey], name, metric.unit || '%');
                html += '</div>';
            }

            html += '</div>';
            showModal(name + ' - Details', html);
        }

        function showCoverageDetails(scheme) {
            var item = currentData.coverageMetrics.find(function(c) { return c.scheme === scheme; });
            if (!item) return;

            var studies = (cachedData.studies || []).filter(function(s) { return s.program === scheme; });

            var html = '<div style="padding: 20px;">';
            html += '<p><strong>Required:</strong> ' + item.required + '</p>';
            html += '<p><strong>Available:</strong> ' + item.available + '</p>';
            html += '<p><strong>Coverage Ratio:</strong> ' + item.ratio.toFixed(2) + 'x</p>';
            html += '<hr style="margin: 16px 0;">';
            html += '<p><strong>Studies in this program (' + studies.length + '):</strong></p>';
            html += '<ul style="margin-top: 8px; padding-left: 20px;">';

            var shown = studies.slice(0, 10);
            for (var i = 0; i < shown.length; i++) {
                html += '<li>' + shown[i].name + ' (' + shown[i].location + ')</li>';
            }
            if (studies.length > 10) {
                html += '<li>... and ' + (studies.length - 10) + ' more</li>';
            }
            html += '</ul></div>';

            showModal(scheme, html);
        }

        function showSpeedDetails(stage) {
            var trends = cachedData.historicalTrends;
            if (!trends || !trends.periods) {
                showModal(stage, '<p>No historical data available.</p>');
                return;
            }

            // Map stage to trend data key
            var dataKey = 'dff';
            var label = 'Days to Flowering';
            if (stage.includes('Male')) {
                label = 'Days to Male Flowering';
            } else if (stage.includes('ASI')) {
                label = 'ASI (Anthesis-Silking Interval)';
            }

            var html = '<div style="padding: 20px;">';
            html += '<h3 style="margin-bottom: 16px;">' + label + ' Over Time</h3>';
            html += renderTrendChart(trends.periods, trends[dataKey], label, 'days');
            html += '<div style="margin-top: 20px;">';
            html += '<table style="width: 100%; font-size: 0.85rem;"><thead><tr><th>Period</th><th style="text-align:right;">Value</th><th style="text-align:right;">Studies</th></tr></thead><tbody>';
            for (var i = 0; i < trends.periods.length; i++) {
                var val = trends[dataKey][i];
                if (val > 0) {
                    html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + val + '</td><td style="text-align:right;">' + trends.studies[i] + '</td></tr>';
                }
            }
            html += '</tbody></table></div></div>';

            showModal(stage, html);
        }

        // Render SVG trend chart with proper axis labels
        function renderTrendChart(labels, values, title, unit) {
            var width = 450, height = 200;
            var marginLeft = 55, marginRight = 20, marginTop = 20, marginBottom = 45;
            var chartWidth = width - marginLeft - marginRight;
            var chartHeight = height - marginTop - marginBottom;

            var filteredData = [];
            for (var i = 0; i < labels.length; i++) {
                if (values[i] > 0) {
                    filteredData.push({ label: labels[i], value: values[i] });
                }
            }
            if (filteredData.length < 2) return '<p style="color: #6b7280;">Not enough data points for chart.</p>';

            var maxVal = Math.max.apply(null, filteredData.map(function(d) { return d.value; }));
            var minVal = Math.min.apply(null, filteredData.map(function(d) { return d.value; }));

            // Add 10% padding to Y range for visual breathing room
            var yPadding = (maxVal - minVal) * 0.1 || maxVal * 0.1;
            var yMin = Math.max(0, minVal - yPadding);
            var yMax = maxVal + yPadding;
            var yRange = yMax - yMin || 1;

            // Calculate nice tick values for Y axis
            var yTicks = [];
            var tickCount = 4;
            for (var t = 0; t <= tickCount; t++) {
                yTicks.push(yMin + (yRange * t / tickCount));
            }

            var xStep = chartWidth / (filteredData.length - 1);
            var points = [];
            for (var i = 0; i < filteredData.length; i++) {
                var x = marginLeft + i * xStep;
                var y = marginTop + chartHeight - ((filteredData[i].value - yMin) / yRange) * chartHeight;
                points.push(x + ',' + y);
            }

            var svg = '<svg width="' + width + '" height="' + height + '" style="background: #f9fafb; border-radius: 8px; font-family: Inter, sans-serif;">';

            // Horizontal grid lines and Y-axis labels
            for (var t = 0; t <= tickCount; t++) {
                var yPos = marginTop + chartHeight - (t / tickCount) * chartHeight;
                var tickVal = yTicks[t];
                // Grid line
                svg += '<line x1="' + marginLeft + '" y1="' + yPos + '" x2="' + (width - marginRight) + '" y2="' + yPos + '" stroke="#e5e7eb" stroke-dasharray="' + (t === 0 ? '0' : '4,4') + '" />';
                // Y-axis tick label
                var labelText = tickVal < 1 ? tickVal.toFixed(3) : tickVal.toFixed(1);
                svg += '<text x="' + (marginLeft - 8) + '" y="' + (yPos + 4) + '" font-size="10" fill="#6b7280" text-anchor="end">' + labelText + '</text>';
            }

            // Y-axis title (rotated)
            svg += '<text x="12" y="' + (marginTop + chartHeight / 2) + '" font-size="11" fill="#374151" text-anchor="middle" transform="rotate(-90, 12, ' + (marginTop + chartHeight / 2) + ')">' + unit + '</text>';

            // Data line
            svg += '<polyline points="' + points.join(' ') + '" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linejoin="round" />';

            // Data points
            for (var i = 0; i < filteredData.length; i++) {
                var x = marginLeft + i * xStep;
                var y = marginTop + chartHeight - ((filteredData[i].value - yMin) / yRange) * chartHeight;
                svg += '<circle cx="' + x + '" cy="' + y + '" r="4" fill="#764ba2" stroke="#fff" stroke-width="1.5" />';
            }

            // X-axis labels (show first, middle, last to avoid crowding)
            var xLabelsToShow = [0, Math.floor(filteredData.length / 2), filteredData.length - 1];
            for (var i = 0; i < xLabelsToShow.length; i++) {
                var idx = xLabelsToShow[i];
                var x = marginLeft + idx * xStep;
                var label = filteredData[idx].label;
                svg += '<text x="' + x + '" y="' + (height - marginBottom + 18) + '" font-size="10" fill="#6b7280" text-anchor="middle">' + label + '</text>';
            }

            // X-axis title
            svg += '<text x="' + (marginLeft + chartWidth / 2) + '" y="' + (height - 5) + '" font-size="11" fill="#374151" text-anchor="middle">Quarter</text>';

            svg += '</svg>';
            return svg;
        }

        function showCycleDetails(cycle) {
            var item = currentData.cycleTimeHistory.find(function(c) { return c.cycle === cycle; });
            if (!item) return;

            var total = item.sampling + item.genotyping + item.planning;
            var html = '<div style="padding: 20px;">';
            html += '<p><strong>Total Cycle Time:</strong> ' + total + ' days</p>';
            html += '<hr style="margin: 16px 0;">';
            html += '<p>üîµ <strong>Sampling:</strong> ' + item.sampling + ' days</p>';
            html += '<p>üü£ <strong>Genotyping:</strong> ' + item.genotyping + ' days</p>';
            html += '<p>üü° <strong>Planning:</strong> ' + item.planning + ' days</p>';
            html += '</div>';

            showModal('Cycle ' + cycle, html);
        }

        function showIssueDetails(issue) {
            var item = currentData.topIssues.find(function(i) { return i.issue === issue; });
            if (!item) return;

            var trends = cachedData.historicalTrends;

            // Map issue to trend key
            var dataKey = null;
            if (issue.includes('Virus') || issue.includes('Spiroplasma')) dataKey = 'virus';
            else if (issue.includes('Stalk')) dataKey = 'stalkLodge';
            else if (issue.includes('Root')) dataKey = 'rootLodge';
            else if (issue.includes('Ear Rot') || issue.includes('Mold')) dataKey = 'earRot';
            else if (issue.includes('Husk')) dataKey = 'poorHusk';
            else if (issue.includes('Lodging')) dataKey = 'lodging';

            var html = '<div style="padding: 20px;">';

            // Stats row
            html += '<div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px;">';
            html += '<div style="flex: 1; min-width: 100px; text-align: center; padding: 16px; background: #fef2f2; border-radius: 8px;">';
            html += '<div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">' + (item.affected || 0).toLocaleString() + '</div>';
            html += '<div style="font-size: 0.8rem; color: #6b7280;">Affected</div></div>';
            html += '<div style="flex: 1; min-width: 100px; text-align: center; padding: 16px; background: #fef2f2; border-radius: 8px;">';
            html += '<div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">' + (item.severe || 0).toLocaleString() + '</div>';
            html += '<div style="font-size: 0.8rem; color: #6b7280;">Severe (>10%)</div></div>';
            html += '<div style="flex: 1; min-width: 100px; text-align: center; padding: 16px; background: #f3f4f6; border-radius: 8px;">';
            html += '<div style="font-size: 1.5rem; font-weight: 700; color: #374151;">' + (item.total || 0).toLocaleString() + '</div>';
            html += '<div style="font-size: 0.8rem; color: #6b7280;">Total Obs</div></div>';
            html += '</div>';

            // Percentage bar
            html += '<div style="margin-bottom: 20px;">';
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">';
            html += '<span style="font-weight: 500;">Incidence Rate</span>';
            html += '<span style="font-weight: 700; color: ' + (item.pct > 50 ? '#ef4444' : item.pct > 20 ? '#f59e0b' : '#10b981') + ';">' + item.pct + '%</span></div>';
            html += '<div style="height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden;">';
            html += '<div style="height: 100%; width: ' + Math.min(item.pct, 100) + '%; background: ' + (item.pct > 50 ? '#ef4444' : item.pct > 20 ? '#f59e0b' : '#10b981') + ';"></div>';
            html += '</div></div>';

            // Impact badge
            html += '<p style="margin-bottom: 16px;"><strong>Impact Level:</strong> ';
            html += '<span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; background: ' + (item.impact === 'High' ? '#fef2f2; color: #dc2626' : item.impact === 'Medium' ? '#fffbeb; color: #d97706' : '#f0fdf4; color: #16a34a') + ';">' + item.impact + '</span></p>';

            // Trend chart
            if (trends && trends.periods && dataKey && trends[dataKey]) {
                html += '<div style="margin-top: 20px;">';
                html += '<h4 style="margin-bottom: 12px;">üìà Historical Trend</h4>';
                html += renderTrendChart(trends.periods, trends[dataKey], issue, '%');

                // Mini data table
                html += '<div style="margin-top: 16px; max-height: 150px; overflow-y: auto;">';
                html += '<table style="width: 100%; font-size: 0.8rem;"><thead><tr><th>Period</th><th style="text-align:right;">Avg %</th></tr></thead><tbody>';
                for (var i = trends.periods.length - 1; i >= 0; i--) {
                    var val = trends[dataKey][i];
                    if (val > 0) {
                        html += '<tr><td>' + trends.periods[i] + '</td><td style="text-align:right;">' + val.toFixed(1) + '%</td></tr>';
                    }
                }
                html += '</tbody></table></div>';
                html += '</div>';
            }

            html += '</div>';
            showModal(issue + ' - Issue Analysis', html);
        }

        function showStackDetails(level) {
            var item = currentData.stackProgress.find(function(s) { return s.level === level; });
            if (!item) return;

            var progress = Math.round((item.count / item.target) * 100);
            var html = '<div style="padding: 20px; text-align: center;">';
            html += '<div style="font-size: 3rem; font-weight: 700; color: #764ba2;">' + item.count + '</div>';
            html += '<div style="color: #6b7280;">out of ' + item.target + ' target</div>';
            html += '<div style="margin-top: 20px;">';
            html += '<div style="height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">';
            html += '<div style="height: 100%; width: ' + progress + '%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>';
            html += '</div>';
            html += '<div style="margin-top: 8px; color: #6b7280;">' + progress + '% of target</div>';
            html += '</div></div>';

            showModal(level, html);
        }

        // Table sorting
        function sortTable(column) {
            // This is a placeholder - would need to implement proper sorting
            console.log('Sort by:', column);
        }

        // Refresh and render
        function refreshData() {
            var icon = document.getElementById('refresh-icon');
            icon.classList.add('loading');

            loadDashboardData(function(data) {
                cachedData = data;
                renderFilters(data);

                currentData = getFilteredData(data);

                renderFunnel(currentData.funnelData);
                renderRates(currentData.rateMetrics);
                renderCoverage(currentData.coverageMetrics);
                renderSpeed(currentData.speedMetrics);
                // Cycle chart removed - no real data available
                renderIssues(currentData.topIssues);
                renderBiofort(currentData.biofortMetrics);
                renderStack(currentData.stackProgress);
                renderPlantMetrics(currentData.plantMetrics);
                renderSummary(currentData.summary);
                updateLastUpdated(data.lastUpdated);

                icon.classList.remove('loading');
            });
        }

        // Filter handling
        document.getElementById('filters-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-chip')) {
                var group = e.target.getAttribute('data-group');
                var value = e.target.getAttribute('data-value');

                // Update filter state
                filters[group] = value;

                // Update UI
                var chips = document.querySelectorAll('.filter-chip[data-group="' + group + '"]');
                for (var i = 0; i < chips.length; i++) {
                    chips[i].classList.remove('active');
                }
                e.target.classList.add('active');

                // Re-render with new filter
                currentData = getFilteredData(cachedData);
                renderFilters(cachedData);
                renderFunnel(currentData.funnelData);
                renderRates(currentData.rateMetrics);
                renderCoverage(currentData.coverageMetrics);
                renderSpeed(currentData.speedMetrics);
                // Cycle chart removed - no real data available
                renderIssues(currentData.topIssues);
                renderBiofort(currentData.biofortMetrics);
                renderStack(currentData.stackProgress);
                renderPlantMetrics(currentData.plantMetrics);
                renderSummary(currentData.summary);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', refreshData);
        } else {
            refreshData();
        }
    </script>
</body>
</html>
