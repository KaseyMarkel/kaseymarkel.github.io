<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Operational & Agronomic Metrics Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            padding: 24px;
            margin-bottom: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.75rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            color: #6b7280;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .last-updated {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            transform: scale(1.05);
        }

        .filter-chip.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .filter-divider {
            width: 1px;
            background: #d1d5db;
            margin: 0 8px;
            align-self: stretch;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Funnel styles */
        .funnel-item {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .funnel-label {
            width: 180px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .funnel-bar-container {
            flex: 1;
            height: 40px;
            background: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .funnel-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            transition: width 0.5s ease;
            min-width: 100px;
        }

        .funnel-value {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .funnel-efficiency {
            color: white;
            font-size: 0.8rem;
        }

        .funnel-target {
            width: 140px;
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Metric cards grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .metric-card {
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .metric-card.green { background: #d1fae5; }
        .metric-card.yellow { background: #fef3c7; }
        .metric-card.red { background: #fee2e2; }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .metric-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .metric-icon { font-size: 1.1rem; }
        .metric-icon.green { color: #10b981; }
        .metric-icon.yellow { color: #f59e0b; }
        .metric-icon.red { color: #ef4444; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .metric-threshold {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Table styles */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
        }

        td { color: #4b5563; }
        tr:hover { background: #f9fafb; }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.green { background: #d1fae5; color: #059669; }
        .status-badge.yellow { background: #fef3c7; color: #d97706; }
        .status-badge.red { background: #fee2e2; color: #dc2626; }

        .ratio.green { color: #10b981; font-weight: 600; }
        .ratio.yellow { color: #f59e0b; font-weight: 600; }
        .ratio.red { color: #ef4444; font-weight: 600; }

        /* Speed metrics */
        .speed-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .speed-grid { grid-template-columns: 1fr; }
            .funnel-label { width: 120px; font-size: 0.8rem; }
            .funnel-target { width: 100px; }
        }

        .speed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .speed-stage { font-weight: 600; color: #1f2937; }
        .speed-target { font-size: 0.8rem; color: #6b7280; margin-top: 4px; }
        .speed-days { font-size: 1.5rem; font-weight: 700; }
        .speed-days.green { color: #10b981; }
        .speed-days.yellow { color: #f59e0b; }
        .speed-days.red { color: #ef4444; }
        .speed-status { font-size: 0.8rem; color: #6b7280; }

        /* Chart */
        .chart-container {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chart-title { font-weight: 600; color: #374151; margin-bottom: 16px; }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            flex: 1;
            padding-top: 20px;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .chart-bar { width: 60px; display: flex; flex-direction: column; }
        .chart-segment { width: 100%; }
        .chart-segment.sampling { background: #667eea; }
        .chart-segment.genotyping { background: #764ba2; }
        .chart-segment.planning { background: #f59e0b; }
        .chart-label { font-size: 0.8rem; color: #6b7280; margin-top: 8px; }

        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        /* Issues */
        .issue-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: background 0.2s;
        }

        .issue-item:hover { background: #f3f4f6; }

        .issue-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .issue-content { flex: 1; }
        .issue-name { font-weight: 600; color: #1f2937; }
        .issue-details { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
        .issue-meta { text-align: right; }

        .issue-impact {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .issue-impact.high { background: #fee2e2; color: #dc2626; }
        .issue-impact.medium { background: #fef3c7; color: #d97706; }
        .issue-impact.low { background: #d1fae5; color: #059669; }
        .issue-trend { font-size: 0.8rem; color: #6b7280; margin-top: 4px; }

        /* Stack */
        .stack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .stack-card {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid #e5e7eb;
        }

        .stack-level { font-size: 0.9rem; font-weight: 500; color: #6b7280; margin-bottom: 8px; }
        .stack-count { font-size: 2.5rem; font-weight: 700; color: #764ba2; margin-bottom: 8px; }
        .stack-target { font-size: 0.8rem; color: #6b7280; }
        .stack-status { margin-top: 12px; font-size: 0.9rem; font-weight: 600; }
        .stack-status.achieved { color: #10b981; }
        .stack-status.pending { color: #f59e0b; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 16px;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .footer p { margin: 4px 0; }

        .loading { display: inline-block; animation: spin 1s linear infinite; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Header -->
        <div class="glass-card">
            <div class="header">
                <div>
                    <h1>üå± BC Operational & Agronomic Metrics</h1>
                    <p>Real-time breeding program performance dashboard</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <span id="refresh-icon">‚Üª</span> Refresh
                    </button>
                    <button class="btn btn-secondary" id="auto-refresh-btn" onclick="toggleAutoRefresh()">
                        ‚è± Auto-refresh OFF
                    </button>
                    <span class="last-updated">Last updated: <span id="last-updated-time">-</span></span>
                </div>
            </div>
            <div class="filters" id="filters-container">
                <button class="filter-chip active" data-group="location" data-value="All">All</button>
                <button class="filter-chip" data-group="location" data-value="Station BC">Station BC</button>
                <button class="filter-chip" data-group="location" data-value="Oriente">Oriente</button>
                <button class="filter-chip" data-group="location" data-value="Estaci√≥n">Estaci√≥n</button>
                <div class="filter-divider"></div>
                <button class="filter-chip active" data-group="scheme" data-value="All">All</button>
                <button class="filter-chip" data-group="scheme" data-value="QPM">QPM</button>
                <button class="filter-chip" data-group="scheme" data-value="Zn">Zn</button>
                <button class="filter-chip" data-group="scheme" data-value="Zn+QPM">Zn+QPM</button>
            </div>
        </div>

        <!-- Block A: Funnel -->
        <div class="glass-card">
            <h2 class="section-title">üìä Block A: Pipeline Funnel</h2>
            <div id="funnel-container"></div>
        </div>

        <!-- Block B: Rates -->
        <div class="glass-card">
            <h2 class="section-title">üìà Block B: Efficiency Rates</h2>
            <div class="metrics-grid" id="rates-container"></div>
        </div>

        <!-- Block C: Coverage -->
        <div class="glass-card">
            <h2 class="section-title">üìã Block C: Coverage Analysis</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Scheme/Stage</th>
                            <th style="text-align: right;">Required</th>
                            <th style="text-align: right;">Available</th>
                            <th style="text-align: right;">Coverage</th>
                            <th style="text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="coverage-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Block D: Speed -->
        <div class="glass-card">
            <h2 class="section-title">‚ö° Block D: Cycle Speed</h2>
            <div class="speed-grid">
                <div id="speed-metrics"></div>
                <div class="chart-container">
                    <div class="chart-title">Cycle Time History</div>
                    <div class="chart-bars" id="cycle-chart"></div>
                    <div class="chart-legend">
                        <div class="legend-item"><div class="legend-color" style="background: #667eea;"></div> Sampling</div>
                        <div class="legend-item"><div class="legend-color" style="background: #764ba2;"></div> Genotyping</div>
                        <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div> Planning</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Issues -->
        <div class="glass-card">
            <h2 class="section-title">‚ö†Ô∏è Top Operational Issues</h2>
            <div id="issues-container"></div>
        </div>

        <!-- Block F: Stack Progress -->
        <div class="glass-card">
            <h2 class="section-title">üß¨ Block F: Trait Pyramiding Progress (Zn + QPM)</h2>
            <div class="stack-grid" id="stack-container"></div>
        </div>

        <!-- Footer -->
        <div class="glass-card footer">
            <p>üì° Connected to BMS API ¬∑ Auto-refresh every 5 minutes when enabled</p>
            <p>üîí View-only access ¬∑ Contact admin for edit permissions</p>
        </div>
    </div>

    <script>
        // State
        var autoRefresh = false;
        var autoRefreshInterval = null;
        var filters = { location: 'All', scheme: 'All' };

        // Mock data
        function generateMockData() {
            return {
                funnelData: [
                    { name: 'Seeds Planted', value: 12500, target: 12000, efficiency: 104 },
                    { name: 'Plants at V4-V6', value: 10800, target: 10200, efficiency: 106 },
                    { name: 'Plants Sampled', value: 10500, target: 10200, efficiency: 103 },
                    { name: 'Valid Genotypes', value: 9850, target: 9800, efficiency: 101 },
                    { name: 'Plants Selected', value: 3200, target: 3000, efficiency: 107 },
                    { name: 'Plants Pollinated', value: 3050, target: 3000, efficiency: 102 },
                    { name: 'Successful Ears (>30k)', value: 2850, target: 2700, efficiency: 106 },
                    { name: 'Ears Harvested', value: 2780, target: 2700, efficiency: 103 }
                ],
                rateMetrics: [
                    { name: 'Emergence Rate', value: 86.4, threshold: 80, status: 'green' },
                    { name: 'V4-V6 Survival', value: 86.4, threshold: 85, status: 'green' },
                    { name: 'Sampling Rate', value: 97.2, threshold: 95, status: 'green' },
                    { name: 'Valid Genotype Rate', value: 93.8, threshold: 90, status: 'green' },
                    { name: 'Pollination Success', value: 93.4, threshold: 85, status: 'green' },
                    { name: 'Rot Loss Rate', value: 2.4, threshold: 5, status: 'green' },
                    { name: 'Lab Eval Rate', value: 98.2, threshold: 95, status: 'green' },
                    { name: 'Lab Pass Rate', value: 96.5, threshold: 90, status: 'green' }
                ],
                coverageMetrics: [
                    { scheme: 'QPM BC1F1', required: 800, available: 920, ratio: 1.15, status: 'green' },
                    { scheme: 'QPM BC2F1', required: 650, available: 720, ratio: 1.11, status: 'green' },
                    { scheme: 'Zn BC1F1', required: 600, available: 680, ratio: 1.13, status: 'green' },
                    { scheme: 'Zn BC2F1', required: 550, available: 540, ratio: 0.98, status: 'red' },
                    { scheme: 'Zn+QPM BC1F1', required: 450, available: 520, ratio: 1.16, status: 'green' },
                    { scheme: 'Zn+QPM BC2F1', required: 350, available: 360, ratio: 1.03, status: 'yellow' }
                ],
                speedMetrics: [
                    { stage: 'Planting ‚Üí Sampling', days: 35, target: 40, status: 'green' },
                    { stage: 'Sampling ‚Üí Genotyping', days: 12, target: 14, status: 'green' },
                    { stage: 'Genotyping ‚Üí Next Planting', days: 18, target: 21, status: 'green' },
                    { stage: 'Total Cycle Time', days: 65, target: 75, status: 'green' }
                ],
                topIssues: [
                    { rank: 1, issue: 'Spiroplasma (Virus)', impact: 'High', plants: 450, pct: 4.2, trend: 'stable' },
                    { rank: 2, issue: 'Climate/Temperature Stress', impact: 'High', plants: 380, pct: 3.5, trend: 'increasing' },
                    { rank: 3, issue: 'Pollination Effectiveness', impact: 'Medium', plants: 200, pct: 6.6, trend: 'stable' },
                    { rank: 4, issue: 'Ear Mold Diseases', impact: 'Medium', plants: 168, pct: 6.0, trend: 'decreasing' },
                    { rank: 5, issue: 'Germination Issues', impact: 'Low', plants: 160, pct: 1.3, trend: 'stable' }
                ],
                stackProgress: [
                    { level: 'Zn+QPM ‚â•60%', count: 245, target: 200 },
                    { level: 'Zn+QPM ‚â•70%', count: 156, target: 120 },
                    { level: 'Zn+QPM ‚â•80% + o2', count: 42, target: 40 }
                ],
                cycleTimeHistory: [
                    { cycle: 'C1', sampling: 38, genotyping: 14, planning: 20 },
                    { cycle: 'C2', sampling: 36, genotyping: 13, planning: 19 },
                    { cycle: 'C3', sampling: 35, genotyping: 12, planning: 18 },
                    { cycle: 'Current', sampling: 35, genotyping: 12, planning: 18 }
                ]
            };
        }

        // Render functions
        function renderFunnel(data) {
            var container = document.getElementById('funnel-container');
            var maxValue = data[0].value;
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var width = (item.value / maxValue) * 100;
                html += '<div class="funnel-item">' +
                    '<div class="funnel-label">' + item.name + '</div>' +
                    '<div class="funnel-bar-container">' +
                        '<div class="funnel-bar" style="width: ' + width + '%;">' +
                            '<span class="funnel-value">' + item.value.toLocaleString() + '</span>' +
                            '<span class="funnel-efficiency">' + item.efficiency + '%</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="funnel-target">Target: ' + item.target.toLocaleString() + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function renderRates(data) {
            var container = document.getElementById('rates-container');
            var icons = { green: '‚úì', yellow: '‚ö†', red: '‚úó' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var m = data[i];
                html += '<div class="metric-card ' + m.status + '">' +
                    '<div class="metric-header">' +
                        '<span class="metric-name">' + m.name + '</span>' +
                        '<span class="metric-icon ' + m.status + '">' + icons[m.status] + '</span>' +
                    '</div>' +
                    '<div class="metric-value">' + m.value.toFixed(1) + '%</div>' +
                    '<div class="metric-threshold">Threshold: ' + m.threshold + '%</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function renderCoverage(data) {
            var tbody = document.getElementById('coverage-body');
            var statusLabels = { green: 'Good', yellow: 'Watch', red: 'Critical' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<tr>' +
                    '<td style="font-weight: 500;">' + item.scheme + '</td>' +
                    '<td style="text-align: right;">' + item.required + '</td>' +
                    '<td style="text-align: right; font-weight: 600;">' + item.available + '</td>' +
                    '<td style="text-align: right;"><span class="ratio ' + item.status + '">' + item.ratio.toFixed(2) + 'x</span></td>' +
                    '<td style="text-align: center;"><span class="status-badge ' + item.status + '">' + statusLabels[item.status] + '</span></td>' +
                '</tr>';
            }
            tbody.innerHTML = html;
        }

        function renderSpeed(data) {
            var container = document.getElementById('speed-metrics');
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var statusText = item.days <= item.target ? '‚úì On track' : '‚ö† Delayed';
                html += '<div class="speed-item">' +
                    '<div>' +
                        '<div class="speed-stage">' + item.stage + '</div>' +
                        '<div class="speed-target">Target: ' + item.target + ' days</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                        '<div class="speed-days ' + item.status + '">' + item.days + 'd</div>' +
                        '<div class="speed-status">' + statusText + '</div>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function renderCycleChart(data) {
            var container = document.getElementById('cycle-chart');
            var maxTotal = 0;
            for (var i = 0; i < data.length; i++) {
                var total = data[i].sampling + data[i].genotyping + data[i].planning;
                if (total > maxTotal) maxTotal = total;
            }
            var scale = 180 / maxTotal;
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<div class="chart-bar-group">' +
                    '<div class="chart-bar">' +
                        '<div class="chart-segment planning" style="height: ' + (item.planning * scale) + 'px;"></div>' +
                        '<div class="chart-segment genotyping" style="height: ' + (item.genotyping * scale) + 'px;"></div>' +
                        '<div class="chart-segment sampling" style="height: ' + (item.sampling * scale) + 'px;"></div>' +
                    '</div>' +
                    '<div class="chart-label">' + item.cycle + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function renderIssues(data) {
            var container = document.getElementById('issues-container');
            var trendIcons = { increasing: 'üìà', decreasing: 'üìâ', stable: '‚û°Ô∏è' };
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                html += '<div class="issue-item">' +
                    '<div class="issue-rank">' + item.rank + '</div>' +
                    '<div class="issue-content">' +
                        '<div class="issue-name">' + item.issue + '</div>' +
                        '<div class="issue-details">' + item.plants + ' plants affected ¬∑ ' + item.pct + '% of population</div>' +
                    '</div>' +
                    '<div class="issue-meta">' +
                        '<span class="issue-impact ' + item.impact.toLowerCase() + '">' + item.impact + ' Impact</span>' +
                        '<div class="issue-trend">Trend: ' + trendIcons[item.trend] + ' ' + item.trend + '</div>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function renderStack(data) {
            var container = document.getElementById('stack-container');
            var html = '';

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var achieved = item.count >= item.target;
                var statusClass = achieved ? 'achieved' : 'pending';
                var statusText = achieved ? '‚úì Target achieved' : (item.target - item.count) + ' more needed';

                html += '<div class="stack-card">' +
                    '<div class="stack-level">' + item.level + '</div>' +
                    '<div class="stack-count">' + item.count + '</div>' +
                    '<div class="stack-target">Target: ' + item.target + '</div>' +
                    '<div class="stack-status ' + statusClass + '">' + statusText + '</div>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        function updateLastUpdated() {
            document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString();
        }

        // Actions
        function refreshData() {
            var icon = document.getElementById('refresh-icon');
            icon.classList.add('loading');

            setTimeout(function() {
                var data = generateMockData();
                renderFunnel(data.funnelData);
                renderRates(data.rateMetrics);
                renderCoverage(data.coverageMetrics);
                renderSpeed(data.speedMetrics);
                renderCycleChart(data.cycleTimeHistory);
                renderIssues(data.topIssues);
                renderStack(data.stackProgress);
                updateLastUpdated();
                icon.classList.remove('loading');
            }, 300);
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            var btn = document.getElementById('auto-refresh-btn');

            if (autoRefresh) {
                btn.textContent = '‚è± Auto-refresh ON';
                btn.classList.add('active');
                autoRefreshInterval = setInterval(refreshData, 300000);
            } else {
                btn.textContent = '‚è± Auto-refresh OFF';
                btn.classList.remove('active');
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            }
        }

        // Filter handling
        document.getElementById('filters-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-chip')) {
                var group = e.target.getAttribute('data-group');
                var value = e.target.getAttribute('data-value');

                // Remove active from same group
                var chips = document.querySelectorAll('.filter-chip[data-group="' + group + '"]');
                for (var i = 0; i < chips.length; i++) {
                    chips[i].classList.remove('active');
                }
                e.target.classList.add('active');

                filters[group] = value;
                refreshData();
            }
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', refreshData);
        } else {
            refreshData();
        }
    </script>
</body>
</html>
